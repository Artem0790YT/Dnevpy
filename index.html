<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Дневник.ру — адаптивная (Full / Lite)</title>

<!-- -------------------------
     СТИЛИ. Полная версия + упрощённая
     ------------------------- -->
<style>
  :root{
    --accent1: #3498db;
    --accent2: #6a11cb;
    --accent3: #2575fc;
    --good: #2ecc71;
    --bad: #e74c3c;
    --bg: #f5f7fb;
    --text: #222;
  }
  html,body{height:100%;margin:0;font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;color:var(--text);background:var(--bg);}

  /* ---------- стартовый экран выбора версии ---------- */
  #startScreen{
    min-height:100vh;
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;
    background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.95));
  }
  #startScreen h1{font-size:28px;margin-bottom:6px;}
  #startScreen p{margin:8px 0 20px;color:#555;}
  .chooseBtns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .btn{
    padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(0,0,0,0.08);
  }
  .btn-full{background:linear-gradient(135deg,var(--accent2),var(--accent3));color:#fff;}
  .btn-lite{background:#fff;border:1px solid #e3e6ea;color:#333;}
  .muted{color:#6b6f76;font-size:14px;margin-top:8px}

  /* ---------- Общие стили для приложений ---------- */
  .app{display:none;min-height:100vh;}
  header.app-header{
    display:flex;align-items:center;justify-content:space-between;padding:12px 20px;color:#fff;
    background:linear-gradient(135deg,var(--accent2),var(--accent3));
  }
  header.app-header .left{display:flex;align-items:center;gap:12px}
  header.app-header .logo{font-weight:700;font-size:18px}
  header.app-header .controls{display:flex;gap:8px;align-items:center}
  .switch-btn{background:#fff;color:#333;padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
  .container{max-width:1200px;margin:20px auto;padding:0 18px}

  /* ---------- Полная версия (rich) ---------- */
  .full .top-row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start}
  .card{background:#ffffff;border-radius:10px;padding:18px;box-shadow:0 6px 20px rgba(21,29,41,0.06);margin-bottom:18px}
  .card h2{margin:0 0 10px;font-size:18px;color:#263238}
  .nav-tabs{display:flex;gap:8px;margin:12px 0 18px;flex-wrap:wrap}
  .nav-tabs .tab{padding:10px 14px;border-radius:8px;background:linear-gradient(180deg,#fff,#f8fbff);cursor:pointer;border:1px solid #e8eef8}
  .nav-tabs .tab.active{border-color:var(--accent1);box-shadow:0 6px 20px rgba(52,152,219,0.12);color:var(--accent1);font-weight:700}
  .controls-row{display:flex;gap:10px;align-items:center}
  .user-info{display:flex;gap:10px;align-items:center;color:#fff}
  .user-info img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.15)}
  .btn-action{background:var(--accent1);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn-danger{background:var(--bad);color:#fff}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f1f4f8;text-align:left}
  th{background:#fbfdff;font-weight:700;color:#3b4a56}

  .grade{display:inline-block;padding:6px 10px;border-radius:999px;color:#fff;font-weight:700}
  .grade.excellent{background:var(--good)}
  .grade.good{background:var(--accent1)}
  .grade.satisfactory{background:#f39c12}
  .grade.bad{background:var(--bad)}

  .homework-item{padding:12px;border-left:6px solid var(--accent1);background:#fbfdff;margin-bottom:12px;border-radius:6px}
  .homework-date{color:#6e767d;font-size:13px;margin-top:6px}

  /* модалки простой стиль */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999}
  .modal .modal-content{background:#fff;padding:18px;border-radius:10px;max-width:520px;width:100%}
  .modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .modal label{display:block;margin:8px 0 6px;font-weight:600}
  .form-group input, .form-group select, .form-group textarea{width:100%;padding:10px;border:1px solid #e6edf3;border-radius:8px;font-size:14px}

  /* ---------- Упрощённая (lite) версия ---------- */
  .lite header.app-header{background:#333}
  .lite .container{padding:10px}
  .lite .card{background:transparent;box-shadow:none;padding:6px;border-radius:0}
  .lite table{border:1px solid #ddd}
  .lite th, .lite td{padding:8px;font-size:14px}
  .lite .smallmuted{color:#666;font-size:13px}

  /* адаптив */
  @media (max-width:768px){
    .nav-tabs{overflow:auto;padding-bottom:8px}
    header.app-header{flex-direction:column;align-items:flex-start;gap:8px;padding:12px}
  }
</style>
</head>
<body>

<!-- ================= START: Start screen (choose version) ================= -->
<div id="startScreen">
  <h1>Добро пожаловать в Дневник.ру</h1>
  <p id="recommendText">Выберите версию интерфейса — полная или упрощённая (рекомендуется для медленных сетей).</p>
  <div class="chooseBtns">
    <button class="btn btn-full" onclick="startApp('full')">Полная версия</button>
    <button class="btn btn-lite" onclick="startApp('lite')">Упрощённая версия</button>
  </div>
  <div class="muted">Можно переключаться в любой момент через кнопку в шапке.</div>
</div>
<!-- ================= END: Start screen ================= -->

<!-- ================= START: Full app ================= -->
<div id="fullApp" class="app full" aria-hidden="true">
  <header class="app-header">
    <div class="left">
      <div class="logo"><i class="fa-book" aria-hidden="true"></i> Дневник.ру — Полная</div>
    </div>

    <div class="controls">
      <div class="user-info">
        <img id="fullAvatar" src="https://ui-avatars.com/api/?name=User&background=3498db&color=fff" alt="User">
        <div style="color:#fff;text-align:right">
          <div id="fullUserName">Гость</div>
          <div id="fullUserRole" style="font-size:13px;opacity:0.9">Неавторизован</div>
        </div>
      </div>
      <button class="switch-btn" onclick="switchVersion('lite')">Упрощённая версия</button>
      <button class="switch-btn" id="openStart" onclick="openStart()">↺ Выбор версии</button>
    </div>
  </header>

  <div class="container">
    <!-- login card -->
    <div id="fullLoginCard" class="card" style="max-width:480px;margin:10px auto;">
      <h2>Вход в систему</h2>
      <div class="form-group">
        <label>Логин</label>
        <input id="fullLogin" type="text" placeholder="Логин (например student)">
      </div>
      <div class="form-group">
        <label>Пароль</label>
        <input id="fullPassword" type="password" placeholder="Пароль">
      </div>
      <div class="form-group">
        <label>Тип пользователя</label>
        <select id="fullUserType">
          <option value="student">Ученик</option>
          <option value="teacher">Учитель</option>
          <option value="admin">Администратор</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <button class="btn-action" onclick="fullLogin()">Войти</button>
        <button class="btn-action" style="background:#7f8c8d" onclick="demoLogin()">Демо (student)</button>
      </div>
      <div id="fullLoginMsg" style="margin-top:10px;color:#c0392b"></div>
    </div>

    <!-- навигация -->
    <div id="fullMain" style="display:none">
      <div class="nav-tabs" id="fullTabs">
        <div class="tab active" data-tab="schedule" onclick="fullSwitchTab(event)">Расписание</div>
        <div class="tab" data-tab="homework" onclick="fullSwitchTab(event)">Домашние задания</div>
        <div class="tab" data-tab="grades" onclick="fullSwitchTab(event)">Оценки</div>
        <div class="tab" data-tab="students" onclick="fullSwitchTab(event)">Ученики</div>
        <div class="tab" data-tab="teachers" onclick="fullSwitchTab(event)">Учителя</div>
      </div>

      <!-- Расписание -->
      <div id="full_schedule_tab" class="card tab-content active">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Расписание на неделю</h2>
          <div>
            <button class="btn-action" onclick="openModal('addScheduleModal')">Добавить урок</button>
            <button class="btn-action" style="background:#95a5a6" onclick="exportData()">Экспорт</button>
          </div>
        </div>
        <div id="fullScheduleContent" style="margin-top:12px"></div>
      </div>

      <!-- Домашние задания -->
      <div id="full_homework_tab" class="card tab-content" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Домашние задания</h2>
          <button class="btn-action" onclick="openModal('addHomeworkModal')">Добавить задание</button>
        </div>
        <div id="fullHomeworkContent" style="margin-top:12px"></div>
      </div>

      <!-- Оценки -->
      <div id="full_grades_tab" class="card tab-content" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Оценки</h2>
          <button class="btn-action" onclick="openModal('addGradeModal')">Добавить оценку</button>
        </div>
        <div id="fullGradesContent" style="margin-top:12px"></div>
      </div>

      <!-- Ученики -->
      <div id="full_students_tab" class="card tab-content" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Ученики</h2>
          <button class="btn-action" onclick="openModal('addStudentModal')">Добавить ученика</button>
        </div>
        <div id="fullStudentsContent" style="margin-top:12px"></div>
      </div>

      <!-- Учителя -->
      <div id="full_teachers_tab" class="card tab-content" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Учителя</h2>
          <button class="btn-action" onclick="openModal('addTeacherModal')">Добавить учителя</button>
        </div>
        <div id="fullTeachersContent" style="margin-top:12px"></div>
      </div>
    </div>
  </div>
</div>
<!-- ================= END: Full app ================= -->

<!-- ================= START: Lite app ================= -->
<div id="liteApp" class="app lite" aria-hidden="true">
  <header class="app-header">
    <div class="logo">Дневник.ру — Упрощённая</div>
    <div class="controls">
      <button class="switch-btn" onclick="switchVersion('full')">Полная версия</button>
      <button class="switch-btn" onclick="openStart()">↺ Выбор версии</button>
    </div>
  </header>

  <div class="container">
    <!-- Упрощённая авторизация (простой ввод) -->
    <div class="card" id="liteLoginCard" style="max-width:720px;margin:8px auto">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="liteLogin" placeholder="Логин" style="padding:8px;border:1px solid #ddd;border-radius:6px">
        <input id="litePassword" placeholder="Пароль" type="password" style="padding:8px;border:1px solid #ddd;border-radius:6px">
        <select id="liteUserType" style="padding:8px;border:1px solid #ddd;border-radius:6px">
          <option value="student">Ученик</option><option value="teacher">Учитель</option><option value="admin">Админ</option>
        </select>
        <button class="btn-action" onclick="liteLogin()">Войти</button>
        <button class="btn-action" style="background:#95a5a6" onclick="demoLogin('lite')">Демо</button>
      </div>
      <div id="liteLoginMsg" class="smallmuted" style="margin-top:8px"></div>
    </div>

    <!-- Контент lite -->
    <div id="liteMain" style="display:none">
      <div class="card">
        <h2>Расписание (лениво)</h2>
        <div id="liteSchedule"></div>
      </div>

      <div class="card">
        <h2>Домашние задания</h2>
        <table>
          <thead><tr><th>Предмет</th><th>Срок</th><th>Описание</th></tr></thead>
          <tbody id="liteHomework"></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Оценки</h2>
        <table>
          <thead><tr><th>Ученик</th><th>Предмет</th><th>Оценки</th></tr></thead>
          <tbody id="liteGrades"></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Учеников — <span id="liteStudentsCount">0</span></h2>
        <div id="liteStudentsList" class="smallmuted"></div>
      </div>

      <div class="card">
        <h2>Учителей</h2>
        <div id="liteTeachersList" class="smallmuted"></div>
      </div>
    </div>
  </div>
</div>
<!-- ================= END: Lite app ================= -->

<!-- ================= START: Modals (shared) ================= -->
<!-- Add Schedule -->
<div id="addScheduleModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Добавить / Редактировать урок</h3>
      <button onclick="closeModal('addScheduleModal')">✕</button>
    </div>
    <div>
      <label>День недели</label>
      <select id="ms_day">
        <option value="monday">Понедельник</option>
        <option value="tuesday">Вторник</option>
        <option value="wednesday">Среда</option>
        <option value="thursday">Четверг</option>
        <option value="friday">Пятница</option>
        <option value="saturday">Суббота</option>
      </select>

      <label>Время</label>
      <input id="ms_time" placeholder="08:30-09:15">

      <label>Предмет</label>
      <input id="ms_subject">

      <label>Кабинет</label>
      <input id="ms_room">

      <label>Учитель</label>
      <input id="ms_teacher">

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn-action" onclick="saveScheduleModal()">Сохранить</button>
        <button class="btn-danger" onclick="closeModal('addScheduleModal')">Отмена</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Homework -->
<div id="addHomeworkModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Добавить домашнее задание</h3>
      <button onclick="closeModal('addHomeworkModal')">✕</button>
    </div>
    <div>
      <label>Предмет</label>
      <select id="mh_subject">
        <option value="Математика">Математика</option>
        <option value="Русский язык">Русский язык</option>
        <option value="Физика">Физика</option>
        <option value="История">История</option>
      </select>

      <label>Срок</label>
      <input id="mh_deadline" type="date">

      <label>Описание</label>
      <textarea id="mh_text" rows="4"></textarea>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn-action" onclick="saveHomeworkModal()">Сохранить</button>
        <button class="btn-danger" onclick="closeModal('addHomeworkModal')">Отмена</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Grade -->
<div id="addGradeModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Добавить оценку</h3>
      <button onclick="closeModal('addGradeModal')">✕</button>
    </div>
    <div>
      <label>Ученик</label>
      <select id="mg_student"></select>

      <label>Предмет</label>
      <select id="mg_subject">
        <option value="Математика">Математика</option>
        <option value="Русский язык">Русский язык</option>
        <option value="Физика">Физика</option>
      </select>

      <label>Оценка</label>
      <select id="mg_value">
        <option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option>
      </select>

      <label>Дата</label>
      <input id="mg_date" type="date" value="">

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn-action" onclick="saveGradeModal()">Сохранить</button>
        <button class="btn-danger" onclick="closeModal('addGradeModal')">Отмена</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Student -->
<div id="addStudentModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Добавить ученика</h3>
      <button onclick="closeModal('addStudentModal')">✕</button>
    </div>
    <div>
      <label>ФИО</label>
      <input id="ms_name">

      <label>Класс</label>
      <input id="ms_class">

      <label>Логин</label>
      <input id="ms_login">

      <label>Пароль</label>
      <input id="ms_pass">

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn-action" onclick="saveStudentModal()">Сохранить</button>
        <button class="btn-danger" onclick="closeModal('addStudentModal')">Отмена</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Teacher -->
<div id="addTeacherModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Добавить учителя</h3>
      <button onclick="closeModal('addTeacherModal')">✕</button>
    </div>
    <div>
      <label>ФИО</label>
      <input id="mt_name">

      <label>Предмет</label>
      <input id="mt_subject">

      <label>Логин</label>
      <input id="mt_login">

      <label>Пароль</label>
      <input id="mt_pass">

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn-action" onclick="saveTeacherModal()">Сохранить</button>
        <button class="btn-danger" onclick="closeModal('addTeacherModal')">Отмена</button>
      </div>
    </div>
  </div>
</div>
<!-- ================= END: Modals ================= -->

<!-- ================= START: Скрипты (логика) ================= -->
<script>
/*
  Полный JS: стартовый экран, выбор версии, авторизация, data in localStorage,
  рендеринг для full и lite, модалки, CRUD (полный набор функций из оригинала)
*/

/* ------------------ Инициализация данных (как у тебя было) ------------------ */
const initialData = {
  users: [
    { id: 1, login: "student", password: "student123", type: "student", name: "Иван Иванов", class: "8А" },
    { id: 2, login: "teacher", password: "teacher123", type: "teacher", name: "Петрова А.И.", subject: "Математика" },
    { id: 3, login: "admin", password: "admin123", type: "admin", name: "Сидоров В.П." }
  ],
  schedule: [
    { id: 1, day: "monday", time: "08:30-09:15", subject: "Математика", room: "205", teacher: "Петрова А.И." },
    { id: 2, day: "monday", time: "09:25-10:10", subject: "Русский язык", room: "112", teacher: "Иванова М.С." },
    { id: 3, day: "tuesday", time: "08:30-09:15", subject: "Физика", room: "301", teacher: "Сидоров В.П." }
  ],
  homework: [
    { id: 1, subject: "Математика", assigned: "12.04.2023", deadline: "17.04.2023", description: "Учебник: стр. 145, № 345-348, 350. Решить задачи на применение теоремы Пифагора." },
    { id: 2, subject: "Русский язык", assigned: "13.04.2023", deadline: "18.04.2023", description: "Учебник: стр. 89-90, упр. 234. Составить предложения с причастными и деепричастными оборотами." }
  ],
  grades: [
    { id: 1, student: "Иван Иванов", subject: "Математика", value: 5, date: "10.04.2023" },
    { id: 2, student: "Иван Иванов", subject: "Математика", value: 4, date: "12.04.2023" },
    { id: 3, student: "Иван Иванов", subject: "Русский язык", value: 4, date: "11.04.2023" },
    { id: 4, student: "Иван Иванов", subject: "Русский язык", value: 3, date: "13.04.2023" }
  ],
  students: [
    { id: 1, name: "Иван Иванов", class: "8А", login: "student1", password: "pass1" },
    { id: 2, name: "Петрова Мария", class: "8А", login: "student2", password: "pass2" },
    { id: 3, name: "Сидоров Алексей", class: "8Б", login: "student3", password: "pass3" }
  ],
  teachers: [
    { id: 1, name: "Петрова Анна Ивановна", subject: "Математика", login: "teacher1", password: "pass1" },
    { id: 2, name: "Иванова Мария Сергеевна", subject: "Русский язык", login: "teacher2", password: "pass2" },
    { id: 3, name: "Сидоров Василий Петрович", subject: "Физика", login: "teacher3", password: "pass3" }
  ]
};

function initializeData(){
  if(!localStorage.getItem('diaryData')){
    localStorage.setItem('diaryData', JSON.stringify(initialData));
  }
  return JSON.parse(localStorage.getItem('diaryData'));
}
function getData(){ return JSON.parse(localStorage.getItem('diaryData')); }
function saveData(d){ localStorage.setItem('diaryData', JSON.stringify(d)); }

let diaryData = initializeData();
let currentUser = null;

/* ------------------ Стартовый экран: совет для 2G ------------------ */
(function recommendVersion(){
  const rec = document.getElementById('recommendText');
  let recommended = '';
  // navigator.connection may not be supported everywhere
  try {
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if(conn && conn.effectiveType){
      if(conn.effectiveType.includes('2g')) recommended = 'Обнаружена медленная сеть (2G). Рекомендуем упрощённую версию.';
      else if(conn.effectiveType.includes('3g')) recommended = 'Сеть 3G — можно выбрать любую версию, но упрощённая может быть быстрее.';
    }
  } catch(e){}
  if(recommended) rec.textContent = recommended;
})();

/* ------------------ Навигация и показ приложений ------------------ */
function startApp(mode){
  document.getElementById('startScreen').style.display = 'none';
  if(mode === 'full'){
    showFull();
  } else {
    showLite();
  }
}
function openStart(){
  // вернуться на выбор версии
  document.getElementById('startScreen').style.display = 'flex';
  hideAllApps();
}
function hideAllApps(){
  document.getElementById('fullApp').style.display = 'none';
  document.getElementById('liteApp').style.display = 'none';
}
function switchVersion(mode){
  // переключиться между версиями без потери данных/состояния
  if(mode === 'full') showFull();
  else showLite();
}

/* ------------------ Show Full ------------------ */
function showFull(){
  hideAllApps();
  document.getElementById('fullApp').style.display = 'block';
  document.getElementById('fullApp').setAttribute('aria-hidden','false');
  // show login or main
  updateFullUserDisplay();
  if(currentUser) {
    document.getElementById('fullLoginCard').style.display = 'none';
    document.getElementById('fullMain').style.display = 'block';
    loadFullAll();
  } else {
    document.getElementById('fullLoginCard').style.display = 'block';
    document.getElementById('fullMain').style.display = 'none';
  }
}

/* ------------------ Show Lite ------------------ */
function showLite(){
  hideAllApps();
  document.getElementById('liteApp').style.display = 'block';
  document.getElementById('liteApp').setAttribute('aria-hidden','false');
  updateLiteUserDisplay();
  if(currentUser) {
    document.getElementById('liteMain').style.display = 'block';
    loadLiteAll();
    document.getElementById('liteLoginCard').style.display = 'none';
  } else {
    document.getElementById('liteMain').style.display = 'none';
    document.getElementById('liteLoginCard').style.display = 'block';
  }
}

/* ------------------ Авторизация (full & lite) ------------------ */
function fullLogin(){
  const u = document.getElementById('fullLogin').value.trim();
  const p = document.getElementById('fullPassword').value;
  const type = document.getElementById('fullUserType').value;
  const found = diaryData.users.find(x => x.login === u && x.password === p && x.type === type);
  if(found){
    currentUser = found;
    document.getElementById('fullLoginMsg').textContent = '';
    updateFullUserDisplay();
    // show main
    document.getElementById('fullLoginCard').style.display = 'none';
    document.getElementById('fullMain').style.display = 'block';
    loadFullAll();
    // also update lite view
    updateLiteUserDisplay();
  } else {
    document.getElementById('fullLoginMsg').textContent = 'Неверный логин/пароль/тип';
  }
}
function liteLogin(){
  const u = document.getElementById('liteLogin').value.trim();
  const p = document.getElementById('litePassword').value;
  const type = document.getElementById('liteUserType').value;
  const found = diaryData.users.find(x => x.login === u && x.password === p && x.type === type);
  if(found){
    currentUser = found;
    document.getElementById('liteLoginMsg').textContent = '';
    updateLiteUserDisplay();
    document.getElementById('liteLoginCard').style.display = 'none';
    document.getElementById('liteMain').style.display = 'block';
    loadLiteAll();
    // also update full
    updateFullUserDisplay();
  } else {
    document.getElementById('liteLoginMsg').textContent = 'Неверный логин/пароль/тип';
  }
}
function demoLogin(target){
  // quick demo: login as default student (from initialData)
  currentUser = diaryData.users.find(u => u.type === 'student') || diaryData.users[0];
  updateFullUserDisplay();
  updateLiteUserDisplay();
  if(target === 'lite') {
    document.getElementById('liteLoginCard').style.display = 'none';
    document.getElementById('liteMain').style.display = 'block';
    loadLiteAll();
    showLite();
  } else {
    document.getElementById('fullLoginCard').style.display = 'none';
    document.getElementById('fullMain').style.display = 'block';
    loadFullAll();
    showFull();
  }
}
function updateFullUserDisplay(){
  if(currentUser){
    document.getElementById('fullUserName').textContent = currentUser.name || currentUser.login;
    let role = currentUser.type === 'student' ? `Ученик ${currentUser.class || ''}` : (currentUser.type === 'teacher' ? `Учитель ${currentUser.subject || ''}` : 'Администратор');
    document.getElementById('fullUserRole').textContent = role;
    document.getElementById('fullAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name || currentUser.login)}&background=3498db&color=fff`;
  } else {
    document.getElementById('fullUserName').textContent = 'Гость';
    document.getElementById('fullUserRole').textContent = 'Неавторизован';
    document.getElementById('fullAvatar').src = `https://ui-avatars.com/api/?name=Guest&background=777&color=fff`;
  }
}
function updateLiteUserDisplay(){
  // lightweight: show small hint in lite login area
  const msg = document.getElementById('liteLoginMsg');
  if(currentUser) msg.textContent = `Вошёл: ${currentUser.name || currentUser.login} (${currentUser.type})`;
  else msg.textContent = 'Вы не вошли. Введите логин и пароль.';
}

/* ------------------ Full tabs switching ------------------ */
function fullSwitchTab(e){
  const clicked = e.currentTarget;
  // tabs visuals
  document.querySelectorAll('#fullTabs .tab').forEach(t => t.classList.remove('active'));
  clicked.classList.add('active');
  // change content
  const tabName = clicked.getAttribute('data-tab');
  ['schedule','homework','grades','students','teachers'].forEach(t => {
    const el = document.getElementById(`full_${t}_tab`);
    if(el) el.style.display = (t === tabName ? 'block' : 'none');
  });
}

/* ------------------ CRUD: Schedule ------------------ */
function loadScheduleForFull(){
  const scheduleContent = document.getElementById('fullScheduleContent');
  scheduleContent.innerHTML = '';
  const days = { monday:'Понедельник', tuesday:'Вторник', wednesday:'Среда', thursday:'Четверг', friday:'Пятница', saturday:'Суббота' };
  Object.keys(days).forEach(dayKey => {
    const dayLessons = diaryData.schedule.filter(l => l.day === dayKey);
    if(dayLessons.length === 0) return;
    const dayWrap = document.createElement('div');
    dayWrap.innerHTML = `<div style="font-weight:700;margin-bottom:8px;color:#2b3a4a">${days[dayKey]}</div>`;
    const table = document.createElement('table');
    table.innerHTML = `<thead><tr><th>Время</th><th>Предмет</th><th>Кабинет</th><th>Учитель</th>${currentUser && currentUser.type !== 'student' ? '<th>Действия</th>' : ''}</tr></thead>`;
    const tbody = document.createElement('tbody');
    dayLessons.forEach(lesson => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${lesson.time}</td><td>${lesson.subject}</td><td>${lesson.room}</td><td>${lesson.teacher}</td>`;
      if(currentUser && currentUser.type !== 'student'){
        const td = document.createElement('td');
        td.innerHTML = `<button class="btn-action" onclick="editSchedule(${lesson.id})" style="margin-right:6px">✎</button><button class="btn-danger" onclick="deleteSchedule(${lesson.id})">🗑️</button>`;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    dayWrap.appendChild(table);
    scheduleContent.appendChild(dayWrap);
  });
}
function openAddScheduleModal(){ openModal('addScheduleModal'); clearScheduleModal(); }
function clearScheduleModal(){
  document.getElementById('ms_day').value = 'monday';
  document.getElementById('ms_time').value = '';
  document.getElementById('ms_subject').value = '';
  document.getElementById('ms_room').value = '';
  document.getElementById('ms_teacher').value = '';
  document.getElementById('addScheduleModal').dataset.editId = '';
}
function saveScheduleModal(){
  const day = document.getElementById('ms_day').value;
  const time = document.getElementById('ms_time').value.trim();
  const subject = document.getElementById('ms_subject').value.trim();
  const room = document.getElementById('ms_room').value.trim();
  const teacher = document.getElementById('ms_teacher').value.trim();
  if(!time || !subject || !room || !teacher){ alert('Заполните все поля'); return; }
  const editId = document.getElementById('addScheduleModal').dataset.editId;
  if(editId){
    diaryData.schedule = diaryData.schedule.map(s => s.id == editId ? {...s, day, time, subject, room, teacher} : s);
  } else {
    const nid = diaryData.schedule.length ? Math.max(...diaryData.schedule.map(s => s.id)) + 1 : 1;
    diaryData.schedule.push({id: nid, day, time, subject, room, teacher});
  }
  saveData(diaryData);
  loadFullAll(); loadLiteAll();
  closeModal('addScheduleModal');
}
function editSchedule(id){
  const lesson = diaryData.schedule.find(l => l.id === id);
  if(!lesson) return;
  document.getElementById('ms_day').value = lesson.day;
  document.getElementById('ms_time').value = lesson.time;
  document.getElementById('ms_subject').value = lesson.subject;
  document.getElementById('ms_room').value = lesson.room;
  document.getElementById('ms_teacher').value = lesson.teacher;
  document.getElementById('addScheduleModal').dataset.editId = id;
  openModal('addScheduleModal');
}
function deleteSchedule(id){
  if(!confirm('Удалить урок?')) return;
  diaryData.schedule = diaryData.schedule.filter(s => s.id !== id);
  saveData(diaryData);
  loadFullAll(); loadLiteAll();
}

/* ------------------ CRUD: Homework ------------------ */
function loadHomeworkForFull(){
  const hw = document.getElementById('fullHomeworkContent');
  hw.innerHTML = '';
  if(diaryData.homework.length === 0){ hw.innerHTML = '<p>Домашних заданий нет</p>'; return; }
  diaryData.homework.forEach(h => {
    const div = document.createElement('div');
    div.className = 'homework-item';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:start">
      <div><b>${h.subject}</b><div class="homework-date">Задано: ${h.assigned} | Срок: ${h.deadline}</div></div>
      <div style="text-align:right">${currentUser && currentUser.type !== 'student' ? `<button class="btn-action" onclick="editHomework(${h.id})">✎</button> <button class="btn-danger" onclick="deleteHomework(${h.id})">🗑</button>` : ''}</div>
    </div>
    <div style="margin-top:8px">${h.description}</div>`;
    hw.appendChild(div);
  });
}
function saveHomeworkModal(){
  const subject = document.getElementById('mh_subject').value;
  const deadline = document.getElementById('mh_deadline').value;
  const text = document.getElementById('mh_text').value.trim();
  if(!subject || !deadline || !text){ alert('Заполните все поля'); return; }
  const newId = diaryData.homework.length ? Math.max(...diaryData.homework.map(h=>h.id))+1 : 1;
  const assigned = new Date().toLocaleDateString('ru-RU');
  diaryData.homework.push({id:newId, subject, assigned, deadline: formatDateForDisplay(deadline), description: text});
  saveData(diaryData);
  loadFullAll(); loadLiteAll();
  closeModal('addHomeworkModal');
}
function editHomework(id){
  const h = diaryData.homework.find(x => x.id === id);
  if(!h) return;
  // prefill
  document.getElementById('mh_subject').value = h.subject;
  // convert dd.mm.yyyy to yyyy-mm-dd if needed
  const dParts = h.deadline.split('.');
  const dd = dParts.length === 3 ? `${dParts[2]}-${dParts[1]}-${dParts[0]}` : '';
  document.getElementById('mh_deadline').value = dd;
  document.getElementById('mh_text').value = h.description;
  // remove old on save by replacing function temporarily (simpler approach: delete first)
  // we'll delete when saving: mark edit id
  document.getElementById('addHomeworkModal').dataset.editId = id;
  openModal('addHomeworkModal');
}
function deleteHomework(id){
  if(!confirm('Удалить задание?')) return;
  diaryData.homework = diaryData.homework.filter(h => h.id !== id);
  saveData(diaryData);
  loadFullAll(); loadLiteAll();
}

/* ------------------ CRUD: Grades ------------------ */
function loadGradesForFull(){
  const el = document.getElementById('fullGradesContent');
  el.innerHTML = '';
  let gradesToShow = diaryData.grades;
  if(currentUser && currentUser.type === 'student') gradesToShow = diaryData.grades.filter(g => g.student === currentUser.name);
  if(gradesToShow.length === 0){ el.innerHTML = '<p>Оценок нет</p>'; return; }
  // group by subject
  const bySub = {};
  gradesToShow.forEach(g => { bySub[g.subject] = bySub[g.subject] || []; bySub[g.subject].push(g); });
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>Предмет</th><th>Оценки</th><th>Средний</th>${currentUser && currentUser.type !== 'student' ? '<th>Действия</th>' : ''}</tr></thead>`;
  const tbody = document.createElement('tbody');
  Object.keys(bySub).forEach(sub => {
    const arr = bySub[sub];
    const vals = arr.map(x => parseInt(x.value));
    const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${sub}</td><td>${arr.map(g=>`<span class="grade ${g.value==5?'excellent':g.value==4?'good':g.value==3?'satisfactory':'bad'}">${g.value}</span>`).join(' ')}</td><td>${avg}</td>`;
    if(currentUser && currentUser.type !== 'student'){
      const td = document.createElement('td');
      td.innerHTML = `<button class="btn-action" onclick="editGrade(${arr[0].id})">✎</button> <button class="btn-danger" onclick="deleteGrade(${arr[0].id})">🗑</button>`;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  el.appendChild(table);
}
function saveGradeModal(){
  const sid = parseInt(document.getElementById('mg_student').value);
  const student = diaryData.students.find(s => s.id === sid);
  const subject = document.getElementById('mg_subject').value;
  const value = parseInt(document.getElementById('mg_value').value);
  const date = document.getElementById('mg_date').value;
  if(!student || !subject || !value || !date){ alert('Заполните все поля'); return; }
  const did = diaryData.grades.length ? Math.max(...diaryData.grades.map(g=>g.id))+1 : 1;
  diaryData.grades.push({id:did, student:student.name, subject, value, date: formatDateForDisplay(date)});
  saveData(diaryData);
  loadFullAll(); loadLiteAll();
  closeModal('addGradeModal');
}
function editGrade(id){ alert('Редактирование оценки пока не реализовано (можно удалить и добавить новую).'); }
function deleteGrade(id){
  if(!confirm('Удалить оценку?')) return;
  diaryData.grades = diaryData.grades.filter(g => g.id !== id);
  saveData(diaryData);
  loadFullAll(); loadLiteAll();
}

/* ------------------ Students & Teachers ------------------ */
function loadStudentsForFull(){
  const el = document.getElementById('fullStudentsContent');
  el.innerHTML = '';
  if(diaryData.students.length === 0){ el.innerHTML = '<p>Учеников нет</p>'; return; }
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>ФИО</th><th>Класс</th><th>Логин</th>${currentUser && currentUser.type==='admin'?'<th>Действия</th>':''}</tr></thead>`;
  const tbody = document.createElement('tbody');
  diaryData.students.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.class}</td><td>${s.login}</td>`;
    if(currentUser && currentUser.type==='admin'){
      const td = document.createElement('td');
      td.innerHTML = `<button class="btn-action" onclick="editStudent(${s.id})">✎</button> <button class="btn-danger" onclick="deleteStudent(${s.id})">🗑</button>`;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  el.appendChild(table);
}
function saveStudentModal(){
  const name = document.getElementById('ms_name').value.trim();
  const cls = document.getElementById('ms_class').value.trim();
  const login = document.getElementById('ms_login').value.trim();
  const pass = document.getElementById('ms_pass').value.trim();
  if(!name||!cls||!login||!pass){ alert('Заполните все поля'); return; }
  if(diaryData.users.some(u => u.login === login) || diaryData.students.some(s => s.login === login)){ alert('Пользователь с таким логином уже есть'); return; }
  const nid = diaryData.students.length ? Math.max(...diaryData.students.map(s=>s.id))+1 : 1;
  diaryData.students.push({id:nid,name, class:cls, login, password: pass});
  const uid = diaryData.users.length ? Math.max(...diaryData.users.map(u=>u.id))+1 : 1;
  diaryData.users.push({id:uid, login, password: pass, type:'student', name, class:cls});
  saveData(diaryData);
  loadFullAll(); loadLiteAll(); closeModal('addStudentModal');
}
function editStudent(id){ alert('Редактирование ученика пока не реализовано.'); }
function deleteStudent(id){
  if(!confirm('Удалить ученика?')) return;
  const s = diaryData.students.find(x=>x.id===id);
  if(s){
    diaryData.students = diaryData.students.filter(x=>x.id!==id);
    diaryData.users = diaryData.users.filter(u=>u.login!==s.login);
    saveData(diaryData);
    loadFullAll(); loadLiteAll();
  }
}

function loadTeachersForFull(){
  const el = document.getElementById('fullTeachersContent');
  el.innerHTML = '';
  if(diaryData.teachers.length === 0){ el.innerHTML = '<p>Учителей нет</p>'; return; }
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>ФИО</th><th>Предмет</th><th>Логин</th>${currentUser && currentUser.type==='admin'?'<th>Действия</th>':''}</tr></thead>`;
  const tbody = document.createElement('tbody');
  diaryData.teachers.forEach(t => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.name}</td><td>${t.subject}</td><td>${t.login}</td>`;
    if(currentUser && currentUser.type==='admin'){
      const td = document.createElement('td');
      td.innerHTML = `<button class="btn-action" onclick="editTeacher(${t.id})">✎</button> <button class="btn-danger" onclick="deleteTeacher(${t.id})">🗑</button>`;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  el.appendChild(table);
}
function saveTeacherModal(){
  const name = document.getElementById('mt_name').value.trim();
  const subject = document.getElementById('mt_subject').value.trim();
  const login = document.getElementById('mt_login').value.trim();
  const pass = document.getElementById('mt_pass').value.trim();
  if(!name||!subject||!login||!pass){ alert('Заполните все поля'); return; }
  if(diaryData.users.some(u => u.login === login) || diaryData.teachers.some(t => t.login === login)){ alert('Пользователь с таким логином уже есть'); return; }
  const nid = diaryData.teachers.length ? Math.max(...diaryData.teachers.map(t=>t.id))+1 : 1;
  diaryData.teachers.push({id:nid,name,subject,login,password:pass});
  const uid = diaryData.users.length ? Math.max(...diaryData.users.map(u=>u.id))+1 : 1;
  diaryData.users.push({id:uid,login,password:pass,type:'teacher',name,subject});
  saveData(diaryData);
  loadFullAll(); loadLiteAll(); closeModal('addTeacherModal');
}
function editTeacher(id){ alert('Редактирование учителя пока не реализовано.'); }
function deleteTeacher(id){
  if(!confirm('Удалить учителя?')) return;
  const t = diaryData.teachers.find(x=>x.id===id);
  if(t){
    diaryData.teachers = diaryData.teachers.filter(x=>x.id!==id);
    diaryData.users = diaryData.users.filter(u=>u.login!==t.login);
    saveData(diaryData);
    loadFullAll(); loadLiteAll();
  }
}

/* ------------------ Lite loaders (упрощённый рендер) ------------------ */
function loadLiteAll(){
  // schedule
  const days = { monday:'Понедельник', tuesday:'Вторник', wednesday:'Среда', thursday:'Четверг', friday:'Пятница', saturday:'Суббота' };
  const sc = document.getElementById('liteSchedule');
  sc.innerHTML = '';
  Object.keys(days).forEach(dk=>{
    const lessons = diaryData.schedule.filter(s=>s.day===dk);
    if(lessons.length){
      const h = document.createElement('div');
      h.innerHTML = `<div style="font-weight:700">${days[dk]}</div>`;
      lessons.forEach(ls => {
        const p = document.createElement('div');
        p.textContent = `${ls.time} — ${ls.subject} (${ls.room}) — ${ls.teacher}`;
        h.appendChild(p);
      });
      sc.appendChild(h);
    }
  });

  // homework table
  const hw = document.getElementById('liteHomework'); hw.innerHTML='';
  diaryData.homework.forEach(h=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${h.subject}</td><td>${h.deadline}</td><td>${h.description}</td>`;
    hw.appendChild(tr);
  });

  // grades
  const lg = document.getElementById('liteGrades'); lg.innerHTML='';
  diaryData.grades.forEach(g=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${g.student}</td><td>${g.subject}</td><td>${g.value}</td>`;
    lg.appendChild(tr);
  });

  // students
  const ls = document.getElementById('liteStudentsList'); ls.innerHTML='';
  diaryData.students.forEach(s => {
    const div = document.createElement('div'); div.textContent = `${s.name} — ${s.class}`;
    ls.appendChild(div);
  });
  document.getElementById('liteStudentsCount').textContent = diaryData.students.length;

  // teachers
  const lt = document.getElementById('liteTeachersList'); lt.innerHTML='';
  diaryData.teachers.forEach(t => {
    const div = document.createElement('div'); div.textContent = `${t.name} — ${t.subject}`;
    lt.appendChild(div);
  });
}

/* ------------------ Full loaders ------------------ */
function loadFullAll(){
  diaryData = getData(); // refresh
  loadScheduleForFull();
  loadHomeworkForFull();
  loadGradesForFull();
  loadStudentsForFull();
  loadTeachersForFull();
  populateGradeStudentsSelect();
}

/* ------------------ Helpers ------------------ */
function openModal(id){ document.getElementById(id).style.display = 'flex'; document.getElementById(id).setAttribute('aria-hidden','false'); }
function closeModal(id){ document.getElementById(id).style.display = 'none'; document.getElementById(id).setAttribute('aria-hidden','true'); 
  // clear editId markers to avoid accidental edits
  if(document.getElementById(id)) document.getElementById(id).dataset.editId = '';
}
function formatDateForDisplay(input){
  // input YYYY-MM-DD -> DD.MM.YYYY ; if already dd.mm.yyyy -> return as is
  if(!input) return '';
  if(input.includes('-')){
    const [y,m,d] = input.split('-'); return `${d}.${m}.${y}`;
  }
  return input;
}

/* ------------------ misc ------------------ */
function populateGradeStudentsSelect(){
  const sel = document.getElementById('mg_student');
  if(!sel) return;
  sel.innerHTML = '';
  diaryData.students.forEach(s => {
    const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; sel.appendChild(opt);
  });
  // set default date to today
  if(document.getElementById('mg_date')) document.getElementById('mg_date').valueAsDate = new Date();
}

/* ------------------ Export (simple) ------------------ */
function exportData(){
  const dataStr = JSON.stringify(diaryData,null,2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'diary_data.json'; document.body.appendChild(a);
  a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ------------------ Startup: auto-suggest lite for 2G and show start ------------------ */
(function startup(){
  // if connection is 2g — open start with recommendation already shown (user chooses)
  // otherwise just show start screen
  document.getElementById('startScreen').style.display = 'flex';
  hideAllApps();
})();
</script>
<!-- ================= END: Скрипты ================= -->

<!-- Font-awesome icons minimal usage (loaded from CDN) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</body>
</html>
